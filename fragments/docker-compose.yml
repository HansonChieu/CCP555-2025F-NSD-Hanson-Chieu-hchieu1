services:
  # Fragments microservice API server
  fragments:
    init: true
    build: .
    environment:
      - API_URL=http://localhost:8080
      - HTPASSWD_FILE=./.htpasswd
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - AWS_REGION=us-east-1
      
      # FIX 1: Point to the 'localstack' container, not localhost
      - AWS_S3_ENDPOINT_URL=http://localstack:4566
      
      # FIX 2: Point to the 'dynamodb-local' container on port 8000
      - AWS_DYNAMODB_ENDPOINT_URL=http://dynamodb-local:8000
      
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME:-fragments}
      - AWS_DYNAMODB_TABLE_NAME=${AWS_DYNAMODB_TABLE_NAME:-fragments}
      
      # FIX 3: Add the missing credentials (REQUIRED)
      - AWS_ACCESS_KEY_ID=ASIA2UC27XMUULNCWYRI
      - AWS_SECRET_ACCESS_KEY=hFeAlOZZcPW2PXKot1r88EZ4OqiNt5IMb6fkE6k7
      - AWS_SESSION_TOKEN=IQoJb3JpZ2luX2VjEOT//////////wEaCXVzLXdlc3QtMiJHMEUCIQDOLM+qLhqEusPZ/dj0TdHbo1Jv6UPdMkEGuYfO49TZEwIgW3uBufF6QLZ7lSrcJo1doH2ZRknBWHK/AvHOmlW69s8qtgIIrf//////////ARAAGgw3MzAzMzUyNjM1MjkiDBDBfMreB5qij0cuLiqKArmVz1xva29t5uvRCZVKLALfDRSEC3OkpeJrCoRqoC/ZNrdjHEBpLS38iINzpPBos741DNdLjFcyshBIP521F3iipBU8IaAL++cpwQL4RnKFzQscHBgSn/I3TdUNzL5pdQrkFk6tsWGodaBuc8wO/xyAgvV8NH1bXP/5ztjre2OgJgv30KBjGaaGoDlZYcjfbeQ1X5Qp7cuweyt3rIKmAUMwvyW91hAIHN/fnD7Xu0syVT7Or9qeWd2x1klYbflM1IsL4zPLhvdPe44zZcVLvw8Qg7YUMGgfS3s2K3mgrvtdET6y62y/vID3mhdqDGjDIaQW56GNKTzxq9Bjb62xGXbdA6ELYxWRhRIHMLne3MkGOp0BVZNgnWncstSteFCCltMp5yZui65x7mfCvSJKlLh9DEAXZf7D2udgngKDQe3v2La8ZcW8J6SfLEUS1AxmGdmWvNpeiYMehz4Cg+/85dEAUkyIfk0gpOVjvztHj9RBE9dm/0AkBw7VYF5OxfacmB2me0fj6xhol8nAWWa+opCNZQYpjfrPHeECYDaZ0ThptdCZgO0kqXB9BTYFKnd94Q==
      
    ports:
      - '8080:8080'
      
  # DynamoDB Local
  dynamodb-local:
    image: amazon/dynamodb-local
    ports:
      - '8000:8000'
    command: ['-jar', 'DynamoDBLocal.jar', '-inMemory']
    
  # LocalStack for S3
  localstack:
    image: localstack/localstack
    ports:
      - '4566:4566'
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=us-east-1